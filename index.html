<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f0f0; }
        #login { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #chat { display: none; height: 100vh; display: flex; flex-direction: column; }
        #sidebar { width: 250px; background: #333; color: white; padding: 10px; overflow-y: auto; }
        #main { flex: 1; display: flex; flex-direction: column; }
        #lobbies { margin-bottom: 10px; }
        #lobby-list { list-style: none; padding: 0; }
        #lobby-list li { padding: 5px; cursor: pointer; }
        #lobby-list li.active { background: #555; }
        #users, #friends { margin-bottom: 10px; }
        #user-list, #friend-list { list-style: none; padding: 0; }
        #user-list li, #friend-list li { padding: 5px; cursor: pointer; }
        #messages { flex: 1; padding: 10px; overflow-y: auto; background: white; border: 1px solid #ccc; }
        #input-area { display: flex; padding: 10px; background: #eee; }
        #message-input { flex: 1; padding: 5px; margin-right: 5px; }
        #send-btn { padding: 5px 10px; }
        .message { margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ddd; }
        .message.own { text-align: right; color: blue; }
        .private { background: #e0f7fa; }
        form { display: flex; flex-direction: column; width: 300px; }
        input, button { margin-bottom: 10px; padding: 5px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div id="login">
        <h1>Login / Register</h1>
        <form id="auth-form">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
            <button type="button" id="register-btn">Register</button>
        </form>
    </div>
    <div id="chat">
        <div id="sidebar">
            <div id="lobbies">
                <h3>Lobbies</h3>
                <ul id="lobby-list"></ul>
                <input type="text" id="new-lobby" placeholder="New Lobby">
                <button id="create-lobby">Create</button>
            </div>
            <div id="users">
                <h3>Users Online</h3>
                <ul id="user-list"></ul>
            </div>
            <div id="friends">
                <h3>Friends</h3>
                <ul id="friend-list"></ul>
                <button id="refresh-friends">Refresh</button>
            </div>
            <button id="logout">Logout</button>
        </div>
        <div id="main">
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Data structures (saved to localStorage)
        let currentUser = null;
        let lobbies = JSON.parse(localStorage.getItem('lobbies')) || { global: { messages: [], users: [] } };
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let friends = JSON.parse(localStorage.getItem('friends')) || {};
        let friendRequests = JSON.parse(localStorage.getItem('friendRequests')) || {};

        // Save data
        function saveData() {
            localStorage.setItem('lobbies', JSON.stringify(lobbies));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('friends', JSON.stringify(friends));
            localStorage.setItem('friendRequests', JSON.stringify(friendRequests));
        }

        // Auth
        document.getElementById('auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (users[username] && users[username].password === password) {
                currentUser = { name: username, online: true };
                users[username].online = true;
                saveData();
                showChat();
            } else {
                alert('Invalid credentials');
            }
        });

        document.getElementById('register-btn').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!users[username]) {
                users[username] = { password, online: true };
                currentUser = { name: username, online: true };
                saveData();
                showChat();
            } else {
                alert('Username taken');
            }
        });

        function showChat() {
            document.getElementById('login').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';
            updateUI();
        }

        // Lobbies
        let currentLobby = 'global';
        document.getElementById('create-lobby').addEventListener('click', () => {
            const name = document.getElementById('new-lobby').value.trim();
            if (name && !lobbies[name]) {
                lobbies[name] = { messages: [], users: [] };
                saveData();
                updateLobbies();
            }
        });

        function updateLobbies() {
            const list = document.getElementById('lobby-list');
            list.innerHTML = '';
            Object.keys(lobbies).forEach(lobby => {
                const li = document.createElement('li');
                li.textContent = lobby;
                li.classList.toggle('active', lobby === currentLobby);
                li.addEventListener('click', () => {
                    currentLobby = lobby;
                    updateLobbies();
                    updateMessages();
                });
                list.appendChild(li);
            });
        }

        // Users
        function updateUsers() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            Object.keys(users).filter(u => users[u].online && u !== currentUser.name).forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                li.addEventListener('click', () => privMsg(user));
                // Friend request button
                const btn = document.createElement('button');
                btn.textContent = 'Friend Req';
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sendFriendRequest(user);
                });
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        // Friends
        function updateFriends() {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            const myFriends = friends[currentUser.name] || [];
            myFriends.forEach(friend => {
                const li = document.createElement('li');
                li.textContent = friend;
                li.addEventListener('click', () => privMsg(friend));
                list.appendChild(li);
            });
        }

        document.getElementById('refresh-friends').addEventListener('click', updateFriends);

        function sendFriendRequest(to) {
            if (!friendRequests[to]) friendRequests[to] = [];
            if (!friendRequests[to].includes(currentUser.name)) {
                friendRequests[to].push(currentUser.name);
                saveData();
                alert(`Friend request sent to ${to}`);
            }
        }

        // Accept friend request (simplified, check on load or something; for demo, assume manual)
        // In a real app, this would be notified.

        // Private Messaging
        let currentPriv = null;
        function privMsg(user) {
            currentPriv = user;
            currentLobby = `priv_${user}`;
            if (!lobbies[currentLobby]) lobbies[currentLobby] = { messages: [], users: [currentUser.name, user] };
            updateLobbies();
            updateMessages();
        }

        // Messages
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const input = document.getElementById('message-input');
            const msg = input.value.trim();
            if (msg) {
                if (!lobbies[currentLobby].messages) lobbies[currentLobby].messages = [];
                lobbies[currentLobby].messages.push({ from: currentUser.name, text: msg, timestamp: Date.now() });
                if (currentPriv) {
                    // Simulate sending to other user (in real app, use WebSockets)
                    console.log(`Private msg to ${currentPriv}: ${msg}`);
                }
                saveData();
                input.value = '';
                updateMessages();
            }
        }

        function updateMessages() {
            const div = document.getElementById('messages');
            div.innerHTML = '';
            if (lobbies[currentLobby] && lobbies[currentLobby].messages) {
                lobbies[currentLobby].messages.forEach(m => {
                    const msgDiv = document.createElement('div');
                    msgDiv.classList.add('message', m.from === currentUser.name ? 'own' : '');
                    if (currentPriv) msgDiv.classList.add('private');
                    msgDiv.innerHTML = `<strong>${m.from}:</strong> ${m.text} <small>${new Date(m.timestamp).toLocaleTimeString()}</small>`;
                    div.appendChild(msgDiv);
                });
            }
            div.scrollTop = div.scrollHeight;
        }

        // Update UI
        function updateUI() {
            updateLobbies();
            updateUsers();
            updateFriends();
            updateMessages();
            // Poll for updates (in real app, use WebSockets)
            setInterval(updateUI, 5000);
        }

        // Logout
        document.getElementById('logout').addEventListener('click', () => {
            if (currentUser) {
                users[currentUser.name].online = false;
                saveData();
            }
            currentUser = null;
            document.getElementById('chat').style.display = 'none';
            document.getElementById('login').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        // Init
        if (currentUser) showChat(); // Auto login if already
    </script>
</body>
</html>
