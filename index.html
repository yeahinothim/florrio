<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f0f0; }
        #login { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #chat { display: none; height: 100vh; display: flex; flex-direction: column; }
        #sidebar { width: 250px; background: #333; color: white; padding: 10px; overflow-y: auto; }
        #main { flex: 1; display: flex; flex-direction: column; }
        #lobbies { margin-bottom: 10px; }
        #lobby-list { list-style: none; padding: 0; }
        #lobby-list li { padding: 5px; cursor: pointer; }
        #lobby-list li.active { background: #555; }
        #users, #pending-reqs, #friends { margin-bottom: 10px; }
        #user-list, #pending-list, #friend-list { list-style: none; padding: 0; }
        #user-list li, #pending-list li, #friend-list li { padding: 5px; cursor: pointer; }
        #messages { flex: 1; padding: 10px; overflow-y: auto; background: white; border: 1px solid #ccc; }
        #input-area { display: flex; padding: 10px; background: #eee; }
        #message-input { flex: 1; padding: 5px; margin-right: 5px; }
        #send-btn { padding: 5px 10px; }
        .message { margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ddd; }
        .message.own { text-align: right; color: blue; }
        .private { background: #e0f7fa; }
        form { display: flex; flex-direction: column; width: 300px; }
        input, button { margin-bottom: 10px; padding: 5px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.small { font-size: 0.8em; padding: 2px 5px; margin-left: 5px; }
    </style>
</head>
<body>
    <div id="login">
        <h1>Login / Register</h1>
        <form id="auth-form">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
            <button type="button" id="register-btn">Register</button>
        </form>
    </div>
    <div id="chat">
        <div id="sidebar">
            <div id="lobbies">
                <h3>Lobbies</h3>
                <ul id="lobby-list"></ul>
                <input type="text" id="new-lobby" placeholder="New Lobby">
                <button id="create-lobby">Create</button>
            </div>
            <div id="users">
                <h3>Users Online</h3>
                <ul id="user-list"></ul>
            </div>
            <div id="pending-reqs">
                <h3>Pending Requests</h3>
                <ul id="pending-list"></ul>
            </div>
            <div id="friends">
                <h3>Friends</h3>
                <ul id="friend-list"></ul>
            </div>
            <button id="logout">Logout</button>
        </div>
        <div id="main">
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, set, get, update, push, onValue, onChildAdded, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // REPLACE WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
            // apiKey: "your-api-key",
            // authDomain: "your-project.firebaseapp.com",
            // databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            // projectId: "your-project",
            // storageBucket: "your-project.appspot.com",
            // messagingSenderId: "123",
            // appId: "your-app-id"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentUsername = null;
        let currentLobby = 'global';
        let currentPriv = null;
        let lobbiesData = {};
        let onlineUsers = {}; // uid: username
        let myFriends = [];
        let pendingReqs = [];
        let unsubscribeFuncs = [];
        let currentMessagesListener = null;

        // Attach real-time listeners
        function attachListeners() {
            unsubscribeFuncs.forEach(unsub => unsub());
            unsubscribeFuncs = [];

            // Lobbies
            const lobbiesUnsub = onValue(ref(db, 'lobbies'), (snap) => {
                lobbiesData = snap.val() || {};
                updateLobbies();
            });
            unsubscribeFuncs.push(lobbiesUnsub);

            // Online users
            const usersUnsub = onValue(ref(db, 'users'), (snap) => {
                onlineUsers = {};
                snap.forEach((child) => {
                    const data = child.val();
                    if (data.online) {
                        onlineUsers[child.key] = data.username;
                    }
                });
                updateUsers();
            });
            unsubscribeFuncs.push(usersUnsub);

            // My friends
            const friendsUnsub = onValue(ref(db, `friends/${currentUsername}`), (snap) => {
                myFriends = snap.val() || [];
                updateFriends();
                updateUsers(); // Refresh friend req buttons
            });
            unsubscribeFuncs.push(friendsUnsub);

            // Pending requests
            const pendingUnsub = onValue(ref(db, `friendRequests/${currentUsername}`), (snap) => {
                pendingReqs = snap.val() || [];
                updatePending();
            });
            unsubscribeFuncs.push(pendingUnsub);

            // Set online and handle disconnect
            const userRef = ref(db, `users/${currentUser.uid}`);
            update(userRef, { online: true }).then(() => {
                onDisconnect(userRef).set({ online: false });
            });
        }

        function detachListeners() {
            unsubscribeFuncs.forEach(unsub => unsub());
            unsubscribeFuncs = [];
            if (currentMessagesListener) {
                currentMessagesListener();
                currentMessagesListener = null;
            }
        }

        // Auth
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const email = `${username}@globalchat.app`;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                alert('Invalid credentials');
            }
        });

        document.getElementById('register-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) return;
            const email = `${username}@globalchat.app`;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await set(ref(db, `users/${cred.user.uid}`), { username, online: true });
            } catch (err) {
                if (err.code === 'auth/email-already-in-use') {
                    alert('Username taken');
                } else {
                    alert(err.message);
                }
            }
        });

        // Auth state change
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                currentUsername = user.email.split('@')[0];
                attachListeners();
                showChat();
            } else {
                detachListeners();
                currentUser = null;
                currentUsername = null;
                showLogin();
            }
        });

        function showChat() {
            document.getElementById('login').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';
            updateLobbies();
            updateMessages();
        }

        function showLogin() {
            document.getElementById('chat').style.display = 'none';
            document.getElementById('login').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Ensure lobby exists
        async function ensureLobby(name) {
            const lobbyRef = ref(db, `lobbies/${name}`);
            const snap = await get(lobbyRef);
            if (!snap.exists()) {
                await set(lobbyRef, { messages: {} });
            }
        }

        // Lobbies
        document.getElementById('create-lobby').addEventListener('click', async () => {
            const name = document.getElementById('new-lobby').value.trim();
            if (name && !lobbiesData[name]) {
                await set(ref(db, `lobbies/${name}`), { messages: {} });
                document.getElementById('new-lobby').value = '';
            }
        });

        function updateLobbies() {
            ensureLobby(currentLobby);
            const list = document.getElementById('lobby-list');
            list.innerHTML = '';
            Object.keys(lobbiesData).forEach((lobby) => {
                const li = document.createElement('li');
                li.textContent = lobby;
                li.classList.toggle('active', lobby === currentLobby);
                li.addEventListener('click', () => {
                    currentLobby = lobby;
                    currentPriv = lobby.startsWith('priv_') ? lobby.split('_')[1] || lobby.split('_')[2] : null;
                    updateLobbies();
                    updateMessages();
                });
                list.appendChild(li);
            });
        }

        // Users
        function updateUsers() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            Object.values(onlineUsers).filter(u => u !== currentUsername).forEach((user) => {
                const li = document.createElement('li');
                li.textContent = user;
                li.addEventListener('click', () => privMsg(user));
                if (!myFriends.includes(user)) {
                    const btn = document.createElement('button');
                    btn.classList.add('small');
                    btn.textContent = 'Friend Req';
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        sendFriendRequest(user);
                    });
                    li.appendChild(btn);
                }
                list.appendChild(li);
            });
        }

        // Pending requests
        function updatePending() {
            const list = document.getElementById('pending-list');
            list.innerHTML = '';
            pendingReqs.forEach((requester) => {
                const li = document.createElement('li');
                li.textContent = requester;
                const btn = document.createElement('button');
                btn.classList.add('small');
                btn.textContent = 'Accept';
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    acceptFriend(requester);
                });
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        function acceptFriend(requester) {
            // Add to my friends
            myFriends.push(requester);
            set(ref(db, `friends/${currentUsername}`), myFriends);

            // Add to their friends
            get(ref(db, `friends/${requester}`)).then((snap) => {
                let tf = snap.val() || [];
                if (!tf.includes(currentUsername)) tf.push(currentUsername);
                set(ref(db, `friends/${requester}`), tf);
            });

            // Remove from pending
            pendingReqs = pendingReqs.filter(p => p !== requester);
            set(ref(db, `friendRequests/${currentUsername}`), pendingReqs);
        }

        function sendFriendRequest(to) {
            if (myFriends.includes(to)) {
                alert('Already friends');
                return;
            }
            get(ref(db, `friendRequests/${to}`)).then((snap) => {
                let reqs = snap.val() || [];
                if (!reqs.includes(currentUsername)) {
                    reqs.push(currentUsername);
                    set(ref(db, `friendRequests/${to}`), reqs);
                    alert(`Friend request sent to ${to}`);
                } else {
                    alert('Request already sent');
                }
            });
        }

        // Friends
        function updateFriends() {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            myFriends.forEach((friend) => {
                const li = document.createElement('li');
                li.textContent = friend;
                li.addEventListener('click', () => privMsg(friend));
                list.appendChild(li);
            });
        }

        // Private Messaging
        function privMsg(user) {
            const [u1, u2] = [currentUsername, user].sort();
            currentLobby = `priv_${u1}_${u2}`;
            currentPriv = user;
            updateLobbies();
            updateMessages();
        }

        // Messages
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const input = document.getElementById('message-input');
            const msg = input.value.trim();
            if (!msg || !currentUsername) return;
            const messagesRef = ref(db, `lobbies/${currentLobby}/messages`);
            push(messagesRef, { from: currentUsername, text: msg, timestamp: Date.now() });
            input.value = '';
        }

        function updateMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            if (currentMessagesListener) {
                currentMessagesListener();
            }
            ensureLobby(currentLobby);
            const messagesRef = ref(db, `lobbies/${currentLobby}/messages`);
            currentMessagesListener = onChildAdded(messagesRef, (snap) => {
                const m = snap.val();
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('message', m.from === currentUsername ? 'own' : '');
                if (currentPriv) msgDiv.classList.add('private');
                msgDiv.innerHTML = `<strong>${m.from}:</strong> ${m.text} <small>${new Date(m.timestamp).toLocaleTimeString()}</small>`;
                messagesDiv.appendChild(msgDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Logout
        document.getElementById('logout').addEventListener('click', async () => {
            if (currentUser) {
                await update(ref(db, `users/${currentUser.uid}`), { online: false });
                await signOut(auth);
            }
        });
    </script>
</body>
</html>
